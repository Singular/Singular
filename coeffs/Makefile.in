#################################################################
###
### Makefile for Singular
###
#################################################################

SHELL		= /bin/sh

##
## various paths
##
top_srcdir	= @top_srcdir@
top_builddir	= @top_builddir@
srcdir		= @srcdir@
prefix 		= @prefix@
exec_prefix 	= @exec_prefix@
libdir 		= @libdir@
# includes are taken from here
includedir	= @includedir@/coeffs

##
## various programs
##

CXX		= @CXX@
INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
INSTALL_DATA	= @INSTALL_DATA@
MKINSTALLDIRS   = ../mkinstalldirs
LN_S		= ln -s

##
## compiler and linker options
##
PIPE		= -pipe
CFLAGS		= @CFLAGS@ ${PIPE}
CXXFLAGS	= @CXXFLAGS@ ${PIPE} -g
CXXTEMPLFLAGS	= -fno-implicit-templates --no-exceptions
CPPFLAGS	= -I${top_srcdir}/.. -I${top_builddir}/.. -I${srcdir}
LDFLAGS		= -L${top_builddir}/../coeffs -L${top_builddir}/../reporter -L${top_builddir}/../resources -L${top_builddir}/../omalloc @LDFLAGS@
DEFS		= -DNDEBUG -DOM_NDEBUG @DEFS@

LIBS		=  @LIBPREFIX@ -lcoeffs -lreporter -lresources -lgmp -lomalloc_ndebug
LIBSG		=  @LIBPREFIX@ -lcoeffs_g -lreporter -lresources -lgmp -lomalloc

#-DHAVE_RINGS 
# -DHAVE_RINGS # Doesn't work :(
# -DNDEBUG -DOM_NDEBUG 

## End configuration dependend stuff
#################################################################

###
### file sets
###

# normal C++ source files
CXXSOURCES= gnumpc.cc gnumpfl.cc longrat.cc longrat0.cc ffields.cc \
            modulop.cc mpr_complex.cc \
            numbers.cc rintegers.cc rmodulo2m.cc rmodulon.cc shortfl.cc

# normal C source files
CSOURCES=

SOURCES=${CSOURCES} ${CXXSOURCES}

HEADERS= gnumpc.h gnumpfl.h longrat.h modulop.h ffields.h \
         mpr_complex.h mpr_global.h numbers.h \
         rintegers.h rmodulo2m.h rmodulon.h shortfl.h

DISTFILES=${SOURCES} ${HEADERS}

OBJS := $(CXXSOURCES:.cc=.o) $(CSOURCES:.c=.o)


all: libcoeffs.a libcoeffs_g.a


.cc.o:	
	${CXX} ${CXXFLAGS} ${CXXTEMPLFLAGS} ${CPPFLAGS} ${DEFS} -c $<
.c.o:
	${CC} ${CFLAGS} ${CPPFLAGS} ${DEFS} -c $<

libcoeffs.a: ${OBJS}
	-rm -f $@
	ar cr $@ $^

## ----------------------------------------------------------------------------
## debug version:
FLAGSG         = -g ${PIPE}
CXXFLAGSG       = -g ${PIPE} ${CXXFLAGS}
DEFSG           = @DEFS@

CCG             = ${CC}
CXXG            = ${CXX} -Wextra -Wall -pedantic -fdiagnostics-show-option -Wno-long-long
OBJSG1 := $(CXXSOURCES:.cc=.og)

libcoeffs_g.a: ${OBJSG1}
	-rm -f libcoeffs_g.a
	ar cr $@ $^

%.og: %.cc
	$(CXXG) ${CXXFLAGSG} ${CXXTEMPLFLAGS} ${CPPFLAGS} ${DEFSG} -c $< -o $@

##
## clean targest
##
mostlyclean: 
	-rm -f *.o *.og core *.op

cleantest: 
	-rm -f test test-g
	-rm -Rf test test.dSYM/

clean: mostlyclean cleantest
	-rm -f *.bak *.d *.dd depend *.a *.so* 

tags:   
	ctags *.c *.h *.cc *.inc

install: all
	${MKINSTALLDIRS} ${includedir}
	${MKINSTALLDIRS} ${libdir}
	${INSTALL_DATA} libcoeffs.a ${libdir}/libcoeffs.a
	${INSTALL_DATA} libcoeffs_g.a ${libdir}/libcoeffs_g.a
	$(INSTALL_DATA) coeffs.h $(includedir)/coeffs.h

test: test.cc libcoeffs.a
	${CXX} ${CXXFLAGS} ${CXXTEMPLFLAGS} ${CPPFLAGS} ${DEFS} test.cc ${LDFLAGS} ${LIBS} -o test


test-g: test.cc libcoeffs_g.a
	${CXXG} ${CXXFLAGSG} ${CXXTEMPLFLAGS} ${CPPFLAGS} ${DEFSG} test.cc ${LDFLAGS} ${LIBSG} -o test-g
